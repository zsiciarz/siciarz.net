---
- hosts: web
  vars:
    temp_path: '{{ ansible_env.HOME }}/tmp'
    project_path: '{{ ansible_env.HOME }}/siciarz.net'
    uv_path: '{{ ansible_env.HOME }}/.local/bin/uv'
  environment:
    TMPDIR: '{{ temp_path }}'
    TMP: '{{ temp_path }}'
  tasks:
    - name: create local temp directory
      file:
        path: '{{ temp_path }}'
        state: directory
    - name: pull current master
      git:
        repo: 'git@github.com:zsiciarz/siciarz.net.git'
        dest: '{{ project_path }}'
        clone: no
    - name: install Python requirements
      shell:
        cmd: '{{ uv_path }} sync --locked --no-dev'
        chdir: '{{ project_path }}'
    - name: migrate database
      shell:
        cmd: '{{ uv_path }} run manage.py migrate'
        chdir: '{{ project_path }}'
    - name: collect static files
      shell:
        cmd: '{{ uv_path }} run manage.py collectstatic --noinput'
        chdir: '{{ project_path }}'
    - name: restart app
      shell:
        cmd: supervisorctl restart siciarz.net
